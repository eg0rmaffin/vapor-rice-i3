#!/bin/bash
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# üîä –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–≤—É–∫–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
audio_setup() {
    echo -e "${CYAN}üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–≤—É–∫–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –±–∏–Ω–¥–∞–º–∏...${RESET}"

    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∞—É–¥–∏–æ-–∫–æ–Ω—Ñ–∏–≥–æ–≤
    mkdir -p ~/dotfiles/i3/includes

    # detect-audio-keys.sh is tracked in the repo (bin/detect-audio-keys.sh).
    # We only ensure it is executable ‚Äî no regeneration, no overwriting.
    # This keeps the dotfiles tree clean after install.sh (declarative & idempotent).
    chmod +x ~/dotfiles/bin/detect-audio-keys.sh
    echo -e "${GREEN}‚úÖ –°–∫—Ä–∏–ø—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞—É–¥–∏–æ-–∫–ª–∞–≤–∏—à –≥–æ—Ç–æ–≤${RESET}"

    # –ò–∑–º–µ–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π i3 –∫–æ–Ω—Ñ–∏–≥, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∞—É–¥–∏–æ-–∫–æ–Ω—Ñ–∏–≥
    if ! grep -q "include.*audio.conf" ~/.config/i3/config; then
        echo -e "${CYAN}üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ i3 –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∞—É–¥–∏–æ...${RESET}"

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∞—É–¥–∏–æ-–±–∏–Ω–¥—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ i3
        sed -i '/XF86Audio/d' ~/.config/i3/config

        # –î–æ–±–∞–≤–ª—è–µ–º include –¥–∏—Ä–µ–∫—Ç–∏–≤—É
        echo "" >> ~/.config/i3/config
        echo "# –í–∫–ª—é—á–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∞—É–¥–∏–æ-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏" >> ~/.config/i3/config
        echo "include ~/dotfiles/i3/includes/audio.conf" >> ~/.config/i3/config

        echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ñ–∏–≥ i3 –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∞—É–¥–∏–æ${RESET}"
    fi

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≤ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ i3, –Ω–æ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    if ! grep -q "detect-audio-keys.sh" ~/.config/i3/config; then
        echo -e "${CYAN}üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –∞—É–¥–∏–æ –≤ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ i3...${RESET}"
        echo "# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É–¥–∏–æ-–∫–ª–∞–≤–∏—à" >> ~/.config/i3/config
        echo "exec_always --no-startup-id ~/dotfiles/bin/detect-audio-keys.sh" >> ~/.config/i3/config
        echo -e "${GREEN}‚úÖ –°–∫—Ä–∏–ø—Ç –∞—É–¥–∏–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ i3${RESET}"
    fi

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏—à, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if [ -n "$DISPLAY" ] && [ ! -f ~/dotfiles/i3/includes/audio.conf ]; then
        echo -e "${CYAN}üîß –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–≤–∏—á–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞—É–¥–∏–æ-–∫–ª–∞–≤–∏—à...${RESET}"
        ~/dotfiles/bin/detect-audio-keys.sh
        echo -e "${GREEN}‚úÖ –ê—É–¥–∏–æ-–∫–ª–∞–≤–∏—à–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã${RESET}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∫–ª–∞–≤–∏—à: –ª–∏–±–æ DISPLAY –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –ª–∏–±–æ –∫–æ–Ω—Ñ–∏–≥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç${RESET}"
    fi

    echo -e "${GREEN}‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–≤—É–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞${RESET}"
}
