# ─────────────────────────────────────────────
# Clean Mic Filter-Chain Configuration
#
# This file is loaded by a dedicated PipeWire filter-chain instance
# (pipewire -c clean-mic-filter-chain.conf) via systemd user service.
#
# DESIGN RATIONALE:
#   The standard approach of using context.modules in pipewire.conf.d/
#   has proven fragile across PipeWire versions. When context.modules
#   fails to load, it fails SILENTLY — no error messages, no nodes created,
#   PipeWire simply continues without the filter-chain.
#
#   By running a separate PipeWire instance with -c flag:
#     1. Explicit startup with clear success/failure indication
#     2. Systemd captures any errors in journal
#     3. Service status shows if Clean Mic is running
#     4. Restart/failure recovery handled by systemd
#     5. Easier debugging (journalctl --user -u pipewire-clean-mic)
#
# Usage:
#   Normally started by: systemd --user pipewire-clean-mic.service
#   Manual test: PIPEWIRE_DEBUG=3 pipewire -c clean-mic-filter-chain.conf
#
# Architecture:
#   [Any Hardware Mic] → RNNoise → [Clean Mic (Audio/Source)]
#
# Applications automatically receive processed audio from Clean Mic.
# Hardware hot-plug (USB/BT mic connect/disconnect) is handled by
# WirePlumber policy — the filter-chain follows the default source.
#
# Dependencies:
#   - noise-suppression-for-voice (provides librnnoise_ladspa.so)
#   - pipewire (provides libpipewire-module-filter-chain)
#
# ─────────────────────────────────────────────

# Context section: this is a minimal PipeWire instance for filter-chain only
context.properties = {
    # Logging: set to 3 for debug, 2 for info, 1 for warnings
    # Inherit from PIPEWIRE_DEBUG env var if set
    log.level = 2

    # Identify this instance in logs
    context.name = "pipewire-clean-mic"
}

# Required modules for filter-chain operation
context.modules = [
    # Protocol-native is required for inter-process communication
    {
        name = libpipewire-module-protocol-native
    }

    # Client-node for creating virtual nodes
    {
        name = libpipewire-module-client-node
    }

    # Adapter for format conversion
    {
        name = libpipewire-module-adapter
    }

    # The actual filter-chain module
    # NOTE: NO nofail here — we WANT this to fail loudly so systemd can report it
    {
        name = libpipewire-module-filter-chain
        args = {
            node.description = "Clean Mic"
            media.name       = "Clean Mic"

            filter.graph = {
                nodes = [
                    # RNNoise: Noise suppression
                    # Removes background noise (fans, keyboard, AC, traffic)
                    # while preserving voice clarity.
                    # Uses noise_suppressor_mono — stable across all PipeWire versions.
                    {
                        type   = ladspa
                        name   = rnnoise
                        plugin = librnnoise_ladspa
                        label  = noise_suppressor_mono
                        control = {
                            # VAD Threshold: voice activity detection sensitivity (0-100%)
                            # Higher = more aggressive gating, lower = more sensitive
                            # 50% is balanced — catches speech without excessive false positives
                            "VAD Threshold (%)" = 50.0

                            # Grace Period: how long to keep audio open after voice stops (ms)
                            # Prevents cutting off word endings and natural speech pauses
                            "VAD Grace Period (ms)" = 200

                            # Retroactive Grace: latency buffer for sentence starts (ms)
                            # Helps capture the beginning of speech even if VAD was slow
                            "Retroactive VAD Grace (ms)" = 0
                        }
                    }
                ]

                # Single-node graph: input → rnnoise → output
                # No explicit links needed for single-node processing.
                inputs  = [ "rnnoise:Input" ]
                outputs = [ "rnnoise:Output" ]
            }

            # Capture side: connects to hardware microphone
            # node.passive = true means it follows the default source
            capture.props = {
                node.name        = "clean_mic_capture"
                node.description = "Clean Mic Input"
                node.passive     = true
                # Force 48000 Hz — RNNoise ONLY works at this sample rate
                audio.rate       = 48000
                audio.channels   = 1
                audio.position   = [ MONO ]
            }

            # Playback side: this is the virtual source applications see
            playback.props = {
                media.class        = Audio/Source
                node.name          = "clean_mic"
                node.description   = "Clean Mic"
                # Not marked as virtual — WirePlumber treats it like a real source
                # for default device selection
                node.virtual       = false
                # Appear in pavucontrol and other mixers as a real device
                device.class       = "sound"
                device.icon-name   = "audio-input-microphone"
                # High priority so WirePlumber picks this as default source
                priority.session   = 1500
                priority.driver    = 1500
                # Fixed sample rate for RNNoise compatibility
                audio.rate         = 48000
                audio.channels     = 1
                audio.position     = [ MONO ]
            }
        }
    }
]
