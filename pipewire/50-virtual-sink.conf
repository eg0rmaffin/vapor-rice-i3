# ─────────────────────────────────────────────
# Virtual Output Sink: persistent audio endpoint for all applications
#
# Problem: When physical audio devices are hot-plugged (Bluetooth on/off,
#          USB headset removed), application streams that were connected
#          directly to the physical device get orphaned, muted, or corked.
#          Games (Minecraft, Steam) and other apps may lose audio permanently
#          until restarted.
#
# Solution: A persistent virtual sink (PipeWire loopback module) that
#           always exists in the audio graph. Applications connect to this
#           virtual sink instead of physical devices. The loopback's playback
#           side is automatically routed by WirePlumber to whatever physical
#           device is currently the default output.
#
# How it works:
#   1. capture side  = "Virtual Output" (Audio/Sink) — apps play here
#   2. playback side = automatically linked to current default physical sink
#   3. When Bluetooth connects: WirePlumber changes default → loopback follows
#   4. When Bluetooth disconnects: WirePlumber changes default back → loopback follows
#   5. Application streams NEVER move — they stay on the virtual sink
#
# Requires: WirePlumber with linking.follow-default-target = true
#           (configured in wireplumber/52-audio-policy-streams.conf)
#
# Applies to: PipeWire 0.3+ (SPA-JSON format)
# Deployed to: ~/.config/pipewire/pipewire.conf.d/
# ─────────────────────────────────────────────

context.modules = [
  {
    name = libpipewire-module-loopback
    args = {
      node.description = "Virtual Output"
      audio.position   = [ FL FR ]

      capture.props = {
        media.class        = Audio/Sink
        node.name          = "virtual_output_sink"
        node.description   = "Virtual Output"
        # Appear in pavucontrol and other mixers as a real device
        device.class       = "sound"
        device.icon-name   = "audio-card"
        # Not marked as virtual — WirePlumber treats it like a real sink
        # for default device selection
        node.virtual       = false
        # High priority so WirePlumber picks this as default output
        priority.session   = 1500
        priority.driver    = 1500
      }

      playback.props = {
        node.name    = "virtual_output_playback"
        # Passive: does not keep the physical sink awake by itself
        node.passive = true
        # No target.object set — WirePlumber links this to default.audio.sink
        # and moves it when default changes (linking.follow-default-target = true)
      }
    }
  }
]
