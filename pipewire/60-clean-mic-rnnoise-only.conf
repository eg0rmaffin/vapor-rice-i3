# ─────────────────────────────────────────────
# Virtual Clean Microphone Source: noise-suppressed, hardware-agnostic
# (Simplified version: RNNoise only, no external limiter dependency)
#
# Problem: Raw microphone input varies wildly across hardware:
#          - Built-in mics expose excessive noise floor
#          - Gain levels are hardware-dependent
#          - USB/Bluetooth mics behave inconsistently
#          - Manual alsamixer tuning is required
#          - No consistent baseline for applications
#
# Solution: A persistent virtual source with noise suppression:
#   1. Hardware microphone (any source)
#   2. → RNNoise noise suppression (removes background noise)
#   3. → "Clean Mic" virtual source (applications connect here)
#
# Architecture:
#   [Any Hardware Mic] → RNNoise → [Clean Mic (Audio/Source)]
#
# Note: This is the simplified version without the limiter stage.
#       The full version (60-clean-mic.conf) includes a LADSPA limiter
#       from swh-plugins, but this version works without that dependency.
#
# Applications automatically receive processed audio from Clean Mic.
# Hardware hot-plug (USB/BT mic connect/disconnect) is handled by
# WirePlumber policy — the filter-chain follows the default source.
#
# Processing policy:
#   - RNNoise: Always enabled, reduces noise floor significantly
#   - No limiter (swh-plugins not installed)
#
# Dependencies:
#   - noise-suppression-for-voice (provides librnnoise_ladspa.so)
#
# Applies to: PipeWire 0.3+ (SPA-JSON format)
# Deployed to: ~/.config/pipewire/pipewire.conf.d/
# ─────────────────────────────────────────────

context.modules = [
  {
    name = libpipewire-module-filter-chain
    args = {
      node.description = "Clean Mic"
      media.name       = "Clean Mic"

      filter.graph = {
        nodes = [
          # RNNoise noise suppression
          # Removes background noise (fans, keyboard, AC, traffic)
          # while preserving voice clarity.
          {
            type   = ladspa
            name   = rnnoise
            plugin = librnnoise_ladspa
            label  = noise_suppressor_mono
            control = {
              # VAD Threshold: voice activity detection sensitivity (0-100%)
              # Higher = more aggressive gating, lower = more sensitive
              # 50% is balanced — catches speech without excessive false positives
              "VAD Threshold (%)" = 50.0

              # Grace Period: how long to keep audio open after voice stops (ms)
              # Prevents cutting off word endings and natural speech pauses
              "VAD Grace Period (ms)" = 200

              # Retroactive Grace: latency buffer for sentence starts (ms)
              # Helps capture the beginning of speech even if VAD was slow
              "Retroactive VAD Grace (ms)" = 0
            }
          }
        ]

        # Input mapping: filter-chain input goes to rnnoise
        inputs = [ "rnnoise:Input" ]

        # Output mapping: rnnoise output goes directly to the filter-chain output
        outputs = [ "rnnoise:Output" ]
      }

      # Capture side: connects to hardware microphone
      # node.passive = true means it follows the default source
      capture.props = {
        node.name        = "clean_mic_capture"
        node.description = "Clean Mic Input"
        node.passive     = true
        # Force 48000 Hz — RNNoise ONLY works at this sample rate
        audio.rate       = 48000
        audio.channels   = 1
        audio.position   = [ MONO ]
      }

      # Playback side: this is the virtual source applications see
      playback.props = {
        media.class        = Audio/Source
        node.name          = "clean_mic"
        node.description   = "Clean Mic"
        # Not marked as virtual — WirePlumber treats it like a real source
        # for default device selection
        node.virtual       = false
        # Appear in pavucontrol and other mixers as a real device
        device.class       = "sound"
        device.icon-name   = "audio-input-microphone"
        # High priority so WirePlumber picks this as default source
        priority.session   = 1500
        priority.driver    = 1500
        # Fixed sample rate for RNNoise compatibility
        audio.rate         = 48000
        audio.channels     = 1
        audio.position     = [ MONO ]
      }
    }
  }
]
