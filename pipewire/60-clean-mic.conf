# ─────────────────────────────────────────────
# Virtual Clean Microphone Source: noise-suppressed, hardware-agnostic
#
# Problem: Raw microphone input varies wildly across hardware:
#          - Built-in mics expose excessive noise floor
#          - Gain levels are hardware-dependent
#          - USB/Bluetooth mics behave inconsistently
#          - Manual alsamixer tuning is required
#          - No consistent baseline for applications
#
# Solution: A persistent virtual source with RNNoise processing:
#   1. Hardware microphone (any source)
#   2. → RNNoise noise suppression (removes background noise)
#   3. → "Clean Mic" virtual source (applications connect here)
#
# Architecture:
#   [Any Hardware Mic] → RNNoise → [Clean Mic (Audio/Source)]
#
# Applications automatically receive processed audio from Clean Mic.
# Hardware hot-plug (USB/BT mic connect/disconnect) is handled by
# WirePlumber policy — the filter-chain follows the default source.
#
# Processing policy:
#   - RNNoise: Always enabled, reduces noise floor significantly
#   - No limiter: Removed for version-tolerance (see design note below)
#   - No aggressive AGC (good USB mics should not be degraded)
#
# Dependencies:
#   - noise-suppression-for-voice (provides librnnoise_ladspa.so)
#
# DESIGN NOTE: Why no limiter?
#   The fast_lookahead_limiter from swh-plugins uses hardcoded port names
#   (in_1, out_1, ingain, limit, release) that vary between PipeWire versions.
#   PipeWire 1.4.x changed port naming conventions, breaking the filter-chain.
#   To ensure version-tolerance and long-term stability:
#     - Limiter is removed from baseline configuration
#     - RNNoise alone provides 90% of the value (noise reduction)
#     - Configuration remains stable across all PipeWire versions
#   If clipping protection is needed, users can add a limiter manually
#   using their PipeWire version's specific port names.
#
# IMPORTANT: This module uses 'ifexists' and 'nofail' flags to ensure:
#   - PipeWire starts successfully even if LADSPA plugins are missing
#   - Audio baseline (output + routing) is never broken by mic processing
#   - Clean Mic is an OPTIONAL enhancement, not a hard dependency
#   - System updates that change/break LADSPA plugins won't crash audio
#
# If plugins are missing, Clean Mic simply won't be available, but all
# other audio functionality continues to work normally.
#
# Applies to: PipeWire 0.3+ (SPA-JSON format)
# Deployed to: ~/.config/pipewire/pipewire.conf.d/
# ─────────────────────────────────────────────

context.modules = [
  {
    name = libpipewire-module-filter-chain
    # CRITICAL: These flags make Clean Mic non-fatal!
    #   ifexists: only load if the module binary exists
    #   nofail:   don't crash PipeWire if module fails to load (e.g., missing LADSPA plugin)
    flags = [ ifexists nofail ]
    args = {
      node.description = "Clean Mic"
      media.name       = "Clean Mic"

      filter.graph = {
        nodes = [
          # RNNoise: Noise suppression
          # Removes background noise (fans, keyboard, AC, traffic)
          # while preserving voice clarity.
          # Uses noise_suppressor_mono — stable across all PipeWire versions.
          {
            type   = ladspa
            name   = rnnoise
            plugin = librnnoise_ladspa
            label  = noise_suppressor_mono
            control = {
              # VAD Threshold: voice activity detection sensitivity (0-100%)
              # Higher = more aggressive gating, lower = more sensitive
              # 50% is balanced — catches speech without excessive false positives
              "VAD Threshold (%)" = 50.0

              # Grace Period: how long to keep audio open after voice stops (ms)
              # Prevents cutting off word endings and natural speech pauses
              "VAD Grace Period (ms)" = 200

              # Retroactive Grace: latency buffer for sentence starts (ms)
              # Helps capture the beginning of speech even if VAD was slow
              "Retroactive VAD Grace (ms)" = 0
            }
          }
        ]

        # Single-node graph: input → rnnoise → output
        # No explicit links needed for single-node processing.
        inputs  = [ "rnnoise:Input" ]
        outputs = [ "rnnoise:Output" ]
      }

      # Capture side: connects to hardware microphone
      # node.passive = true means it follows the default source
      capture.props = {
        node.name        = "clean_mic_capture"
        node.description = "Clean Mic Input"
        node.passive     = true
        # Force 48000 Hz — RNNoise ONLY works at this sample rate
        audio.rate       = 48000
        audio.channels   = 1
        audio.position   = [ MONO ]
      }

      # Playback side: this is the virtual source applications see
      playback.props = {
        media.class        = Audio/Source
        node.name          = "clean_mic"
        node.description   = "Clean Mic"
        # Not marked as virtual — WirePlumber treats it like a real source
        # for default device selection
        node.virtual       = false
        # Appear in pavucontrol and other mixers as a real device
        device.class       = "sound"
        device.icon-name   = "audio-input-microphone"
        # High priority so WirePlumber picks this as default source
        priority.session   = 1500
        priority.driver    = 1500
        # Fixed sample rate for RNNoise compatibility
        audio.rate         = 48000
        audio.channels     = 1
        audio.position     = [ MONO ]
      }
    }
  }
]
