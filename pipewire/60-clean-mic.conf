# ─────────────────────────────────────────────
# Virtual Clean Microphone Source: noise-suppressed, limited, hardware-agnostic
#
# Problem: Raw microphone input varies wildly across hardware:
#          - Built-in mics expose excessive noise floor
#          - Gain levels are hardware-dependent
#          - USB/Bluetooth mics behave inconsistently
#          - Manual alsamixer tuning is required
#          - No consistent baseline for applications
#
# Solution: A persistent virtual source with processing chain:
#   1. Hardware microphone (any source)
#   2. → RNNoise noise suppression (removes background noise)
#   3. → Limiter (prevents clipping, protects against loud sounds)
#   4. → "Clean Mic" virtual source (applications connect here)
#
# Architecture:
#   [Any Hardware Mic] → filter-chain → [Clean Mic (Audio/Source)]
#
# Applications automatically receive processed audio from Clean Mic.
# Hardware hot-plug (USB/BT mic connect/disconnect) is handled by
# WirePlumber policy — the filter-chain follows the default source.
#
# Processing policy:
#   - RNNoise: Always enabled, reduces noise floor significantly
#   - Limiter: Always enabled, prevents clipping at -3dB ceiling
#   - No aggressive AGC (good USB mics should not be degraded)
#
# Dependencies:
#   - noise-suppression-for-voice (provides librnnoise_ladspa.so)
#   - swh-plugins (provides fast_lookahead_limiter)
#
# Applies to: PipeWire 0.3+ (SPA-JSON format)
# Deployed to: ~/.config/pipewire/pipewire.conf.d/
# ─────────────────────────────────────────────

context.modules = [
  {
    name = libpipewire-module-filter-chain
    args = {
      node.description = "Clean Mic"
      media.name       = "Clean Mic"

      filter.graph = {
        nodes = [
          # Stage 1: Noise suppression using RNNoise
          # Removes background noise (fans, keyboard, AC, traffic)
          # while preserving voice clarity.
          {
            type   = ladspa
            name   = rnnoise
            plugin = librnnoise_ladspa
            label  = noise_suppressor_mono
            control = {
              # VAD Threshold: voice activity detection sensitivity (0-100%)
              # Higher = more aggressive gating, lower = more sensitive
              # 50% is balanced — catches speech without excessive false positives
              "VAD Threshold (%)" = 50.0

              # Grace Period: how long to keep audio open after voice stops (ms)
              # Prevents cutting off word endings and natural speech pauses
              "VAD Grace Period (ms)" = 200

              # Retroactive Grace: latency buffer for sentence starts (ms)
              # Helps capture the beginning of speech even if VAD was slow
              "Retroactive VAD Grace (ms)" = 0
            }
          }

          # Stage 2: Limiter to prevent clipping
          # Fast lookahead limiter with ~5ms latency
          # Protects against sudden loud sounds (coughs, bumps, shouts)
          {
            type   = ladspa
            name   = limiter
            plugin = fast_lookahead_limiter_1913
            label  = fastLookaheadLimiter
            control = {
              # Input gain: 0dB (no boost, trust the hardware level)
              # Range: -20 to 20 dB
              "ingain" = 0.0

              # Limit: -3dB ceiling leaves headroom, prevents digital clipping
              # Range: -20 to 0 dB
              "limit" = -3.0

              # Release time: how quickly the limiter recovers after limiting
              # Range: 0.01 to 2.0 seconds
              # 0.1s is natural-sounding, not pumpy
              "release" = 0.1
            }
          }
        ]

        # Input mapping: filter-chain input goes to rnnoise
        inputs = [ "rnnoise:Input" ]

        # Signal flow: rnnoise → limiter (using channel 1 of stereo limiter for mono)
        links = [
          { output = "rnnoise:Output" input = "limiter:in_1" }
        ]

        # Output mapping: limiter out_1 goes to the filter-chain output
        outputs = [ "limiter:out_1" ]
      }

      # Capture side: connects to hardware microphone
      # node.passive = true means it follows the default source
      capture.props = {
        node.name        = "clean_mic_capture"
        node.description = "Clean Mic Input"
        node.passive     = true
        # Force 48000 Hz — RNNoise ONLY works at this sample rate
        audio.rate       = 48000
        audio.channels   = 1
        audio.position   = [ MONO ]
      }

      # Playback side: this is the virtual source applications see
      playback.props = {
        media.class        = Audio/Source
        node.name          = "clean_mic"
        node.description   = "Clean Mic"
        # Not marked as virtual — WirePlumber treats it like a real source
        # for default device selection
        node.virtual       = false
        # Appear in pavucontrol and other mixers as a real device
        device.class       = "sound"
        device.icon-name   = "audio-input-microphone"
        # High priority so WirePlumber picks this as default source
        priority.session   = 1500
        priority.driver    = 1500
        # Fixed sample rate for RNNoise compatibility
        audio.rate         = 48000
        audio.channels     = 1
        audio.position     = [ MONO ]
      }
    }
  }
]
