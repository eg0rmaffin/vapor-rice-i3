# ─────────────────────────────────────────────
# Microphone Input Policy: clean-mic as default, hardware-agnostic
#
# Problem: Applications connect directly to hardware microphones, which:
#          - Exposes raw noise floor to applications
#          - Creates inconsistent experience across mic types
#          - Requires per-app configuration
#          - Breaks on hardware hot-plug (USB mic disconnect)
#
# Solution: All applications use "clean_mic" virtual source (filter-chain)
#           that provides noise-suppressed, limited audio regardless of
#           which physical microphone is connected.
#
# Policy:
#   - clean_mic is the default input source for all applications
#   - Application streams follow the default source (no stickiness)
#   - Hardware sources connect to the filter-chain capture side
#   - Hot-plug: new hardware automatically feeds the filter-chain
#   - Disconnected hardware: rebinds to next available source
#
# Architecture:
#   [App 1] ←──────────┐
#   [App 2] ←──────────┼─ [clean_mic] ← filter-chain ← [Hardware Mic]
#   [App 3] ←──────────┘                                     ↑
#                                             (auto-follows default source)
#
# Applies to: WirePlumber 0.5+ (SPA-JSON format)
# Deployed to: ~/.config/wireplumber/wireplumber.conf.d/
# ─────────────────────────────────────────────

wireplumber.settings = {
  # --- Input stream policy ---

  # Do NOT restore a previously stored per-app input device.
  # This prevents apps from "sticking" to a specific hardware mic.
  # ALL input streams always use the current default source (clean_mic).
  node.stream.restore-source-target = false

  # Do NOT auto-switch to headset mic profile when application requests input.
  # This preserves A2DP high-quality audio output on Bluetooth headphones.
  # (Already set in 51-audio-policy-bluetooth.conf, repeated for clarity)
  # bluetooth.autoswitch-to-headset-profile = false
}

# --- Clean Mic priority boost ---
# Ensure clean_mic wins default source selection over raw hardware mics

monitor.alsa.rules = [
  # Lower priority of raw ALSA input devices so clean_mic wins
  {
    matches = [
      { node.name = "~alsa_input.*" }
    ]
    actions = {
      update-props = {
        # Lower than clean_mic's 1500
        priority.session = 1000
        priority.driver  = 1000
      }
    }
  }
]

# USB microphones: same policy (lower priority, let clean_mic be default)
# Bluetooth inputs are already deprioritized by disabling HSP/HFP in 51-audio-policy-bluetooth.conf
