# ─────────────────────────────────────────────
# Bluetooth Audio Policy: high-quality A2DP, no HSP/HFP auto-switch
#
# Problem: WirePlumber auto-switches Bluetooth headsets from A2DP (high quality)
#          to HSP/HFP (low quality telephony) when any app requests microphone.
#          This degrades output audio quality unexpectedly.
#
# Policy:  Input and output are independent. Microphone usage must NOT change
#          the output codec, bitrate, or profile.
#
# Applies to: WirePlumber 0.5+ (SPA-JSON format)
# Deployed to: ~/.config/wireplumber/wireplumber.conf.d/
# ─────────────────────────────────────────────

wireplumber.settings = {
  # Do NOT auto-switch from A2DP to HSP/HFP when a microphone stream appears.
  # This keeps high-quality audio output even when input is requested.
  bluetooth.autoswitch-to-headset-profile = false

  # Persist Bluetooth device settings (codec, volume) across reboots
  bluetooth.use-persistent-storage = true
}

monitor.bluez.properties = {
  # Only enable A2DP and LE Audio (BAP) roles — disable HSP/HFP entirely.
  # This prevents any automatic or manual switch to narrow-band telephony profiles.
  bluez5.roles = [ a2dp_sink a2dp_source bap_sink bap_source ]

  # Preferred codecs in quality order (highest first):
  #   ldac     — Sony, up to 990 kbps (best quality)
  #   aptx_hd  — Qualcomm, 576 kbps
  #   aptx     — Qualcomm, 352 kbps
  #   aac      — Apple, ~256 kbps
  #   sbc_xq   — Enhanced SBC, ~420 kbps
  #   sbc      — Standard Bluetooth, ~328 kbps (fallback)
  bluez5.codecs = [ ldac aptx_hd aptx aac sbc_xq sbc ]

  # Enable high-quality SBC variant (SBC-XQ) when available
  bluez5.enable-sbc-xq = true

  # Enable mSBC for better HFP quality if HFP is ever forced manually
  bluez5.enable-msbc = true

  # Let hardware handle volume (reduces latency, improves quality)
  bluez5.enable-hw-volume = true

  # Completely disable HFP/HSP backend — no telephony profiles at all.
  # Options: native, ofono, none
  bluez5.hfphsp-backend = none
}

monitor.bluez.rules = [
  {
    matches = [
      { device.name = "~bluez_card.*" }
    ]
    actions = {
      update-props = {
        # Only auto-connect A2DP profiles (not HFP/HSP)
        bluez5.auto-connect = [ a2dp_sink a2dp_source ]

        # Hardware volume for A2DP only
        bluez5.hw-volume = [ a2dp_sink a2dp_source ]

        # LDAC quality: auto, hq (990/660 kbps), sq (396/328 kbps), mq (132/109 kbps)
        bluez5.a2dp.ldac.quality = hq

        # AAC constant bitrate mode (0 = CBR, most predictable)
        bluez5.a2dp.aac.bitratemode = 0
      }
    }
  }
]
