#!/bin/bash
# bin/detect-kbd-backlight-keys.sh
# Detect available keyboard backlight keys and generate i3 config
# Declarative keyboard lighting configuration

KBD_CONF="$HOME/dotfiles/i3/includes/kbd-backlight.conf"
KBD_SCRIPT="$HOME/dotfiles/bin/kbd-backlight.sh"

# Check if config already exists
if [ -f "$KBD_CONF" ]; then
    # Config exists, don't overwrite
    exit 0
fi

# Ensure directory exists
mkdir -p "$(dirname "$KBD_CONF")"

# Start generating config
echo "# Keyboard backlight configuration" > "$KBD_CONF"
echo "# Auto-generated by detect-kbd-backlight-keys.sh" >> "$KBD_CONF"
echo "" >> "$KBD_CONF"

# Check for keyboard backlight device
LEDS_DIR="/sys/class/leds"
HAS_KBD_BACKLIGHT=false

for pattern in "*kbd*" "*keyboard*"; do
    for device in "$LEDS_DIR"/$pattern; do
        if [ -d "$device" ] && [ -f "$device/brightness" ]; then
            HAS_KBD_BACKLIGHT=true
            break 2
        fi
    done
done

if [ "$HAS_KBD_BACKLIGHT" = false ]; then
    echo "# No keyboard backlight device detected on this system" >> "$KBD_CONF"
    echo "# Keybindings are still added but will show error message if used" >> "$KBD_CONF"
    echo "" >> "$KBD_CONF"
fi

# Check for XF86KbdBrightness keys (common on laptops)
KBD_KEYS=()

if command -v xmodmap &>/dev/null; then
    if xmodmap -pke 2>/dev/null | grep -q XF86KbdBrightnessUp; then
        KBD_KEYS+=("XF86KbdBrightnessUp")
    fi
    if xmodmap -pke 2>/dev/null | grep -q XF86KbdBrightnessDown; then
        KBD_KEYS+=("XF86KbdBrightnessDown")
    fi
    if xmodmap -pke 2>/dev/null | grep -q XF86KbdLightOnOff; then
        KBD_KEYS+=("XF86KbdLightOnOff")
    fi
fi

# Generate keybindings
if [ ${#KBD_KEYS[@]} -gt 0 ]; then
    echo "# XF86 keyboard backlight keys detected" >> "$KBD_CONF"

    if [[ " ${KBD_KEYS[*]} " =~ "XF86KbdBrightnessUp" ]]; then
        echo "bindsym XF86KbdBrightnessUp exec --no-startup-id $KBD_SCRIPT up" >> "$KBD_CONF"
    fi

    if [[ " ${KBD_KEYS[*]} " =~ "XF86KbdBrightnessDown" ]]; then
        echo "bindsym XF86KbdBrightnessDown exec --no-startup-id $KBD_SCRIPT down" >> "$KBD_CONF"
    fi

    if [[ " ${KBD_KEYS[*]} " =~ "XF86KbdLightOnOff" ]]; then
        echo "bindsym XF86KbdLightOnOff exec --no-startup-id $KBD_SCRIPT toggle" >> "$KBD_CONF"
    fi
else
    echo "# Standard XF86 keyboard backlight keys not detected" >> "$KBD_CONF"
    echo "# Using alternative key combinations (Mod+F5/F6/F7)" >> "$KBD_CONF"
    echo "" >> "$KBD_CONF"
    echo "# Keyboard backlight up" >> "$KBD_CONF"
    echo "bindsym \$mod+F6 exec --no-startup-id $KBD_SCRIPT up" >> "$KBD_CONF"
    echo "# Keyboard backlight down" >> "$KBD_CONF"
    echo "bindsym \$mod+F5 exec --no-startup-id $KBD_SCRIPT down" >> "$KBD_CONF"
    echo "# Toggle keyboard backlight" >> "$KBD_CONF"
    echo "bindsym \$mod+F7 exec --no-startup-id $KBD_SCRIPT toggle" >> "$KBD_CONF"
fi

echo "" >> "$KBD_CONF"
echo "# Additional keyboard backlight controls" >> "$KBD_CONF"
echo "# Mod+Shift+L for max brightness" >> "$KBD_CONF"
echo "bindsym \$mod+Shift+l exec --no-startup-id $KBD_SCRIPT max" >> "$KBD_CONF"
echo "# Mod+Shift+K for off" >> "$KBD_CONF"
echo "bindsym \$mod+Shift+k exec --no-startup-id $KBD_SCRIPT off" >> "$KBD_CONF"

exit 0
